image: ubuntu:22.04



stages:
  - package
  - publish
  - deploy

include:
  - "https://git.amaze360.nl/templates/devops-templates/-/raw/development/ci/publish-apache-server.yml"
  - "https://git.amaze360.nl/templates/devops-templates/-/raw/development/ci/deploy-app.yml"

package_charts:
  stage: package
  before_script: 
    - apt-get update -y && apt-get install -y curl tar git
    - curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
    - chmod 700 get_helm.sh
    - ./get_helm.sh
    - git fetch origin "pages360"
    - git remote set-url origin https://${GITLAB_USER_NAME}:${GITLAB_CI_TOKEN}@${CI_REPOSITORY_URL#*@}
  script:
    - git checkout pages360
    - git checkout remotes/origin/development -- charts scripts public/index.html .gitignore .gitlab-ci.yml
    - cd charts
    - ../scripts/process-charts.sh
    - cd ..
    - helm repo index --url ${CI_PAGES_URL} ./public
    - rm -r charts scripts get_helm.sh
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git add .
    - git commit -m "Publish Helm charts and additional files"
    - git push origin pages360
  rules:
    - if: $CI_COMMIT_BRANCH == "development"

pages:
  stage: deploy
  script:
    - echo "Pages accessible through ${CI_PAGES_URL}"
  pages:
    path_prefix: "$PAGES_PREFIX"
  artifacts:
    paths:
    - public
  rules:
    - if: $CI_COMMIT_BRANCH == "pages360"